@page "/"
@using System.Net.Http.Headers
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@attribute [Authorize]
@inject HttpClient Http
@inject MessageService _message
@inject IAccessTokenProvider TokenProvider
@inject IConfiguration Configuration

<PageTitle>ファイル一括アップロード</PageTitle>

<AuthorizeView>
    <Authorized>
        <div style="padding: 24px; max-width: 800px; margin: 0 auto;">
            <Card Title="ファイル一括アップロード">
                <p>以下のエリアにファイルをドラッグ＆ドロップするか、クリックしてアップロードしてください。</p>

                <Upload Action="@uploadUrl"
                        Name="files"
                        Multiple="true"
                        Drag="true"
                        Headers="@headers"
                        OnChange="HandleChange">
                    <p class="ant-upload-drag-icon">
                        <Icon Type="inbox" />
                    </p>
                    <p class="ant-upload-text">クリック、またはファイルをこのエリアにドラッグしてアップロード</p>
                    <p class="ant-upload-hint">
                        単一または複数のファイルのアップロードをサポートしています。
                    </p>
                </Upload>
            </Card>

            <div style="margin-top: 24px;">
                <Card Title="アップロード済みファイル一覧">
                    <Table DataSource="@fileList" Size="TableSize.Small" Context="tableContext">
                        <PropertyColumn Property="c=>c.Name" Title="ファイル名" />
                        <PropertyColumn Property="c=>c.Size" Title="サイズ (Bytes)" />
                        <PropertyColumn Property="c => c.LastModified" Title="更新日時" />
                    </Table>
                </Card>
            </div>
        </div>
    </Authorized>
    <NotAuthorized>
        <div style="text-align: center; margin-top: 50px;">
             <h2>ファイルをアップロードするにはログインしてください。</h2>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    Dictionary<string, string> headers = new Dictionary<string, string>();
    string uploadUrl = "";
    string listUrl = "";
    List<BlobInfo> fileList = new List<BlobInfo>();

    protected override async Task OnInitializedAsync()
    {
        var apiBaseUrl = Configuration["ApiBaseUrl"]; 
        if (string.IsNullOrEmpty(apiBaseUrl))
        {
             // Fallback if not configured (e.g. production SWA)
             // If ApiBaseUrl is explicit, use it. Otherwise assume relative path (SWA proxy)
             uploadUrl = "api/files/upload";
             listUrl = "api/files/list";
        }
        else 
        {
            // Remove trailing slash if present to avoid double slash
            apiBaseUrl = apiBaseUrl.TrimEnd('/');
            uploadUrl = $"{apiBaseUrl}/api/files/upload";
            listUrl = $"{apiBaseUrl}/api/files/list";
        }

        var result = await TokenProvider.RequestAccessToken();
        if (result.TryGetToken(out var token))
        {
            headers["Authorization"] = $"Bearer {token.Value}";
        }
        
        await LoadFiles();
    }

    private async Task HandleChange(UploadInfo fileinfo)
    {
        if (fileinfo.File.State == UploadState.Success)
        {
            _message.Success($"{fileinfo.File.FileName} のアップロードに成功しました");
            await LoadFiles();
        }
        else if (fileinfo.File.State == UploadState.Fail)
        {
            _message.Error($"{fileinfo.File.FileName} のアップロードに失敗しました。サーバーエラー: {fileinfo.File.Response}");
        }
    }

    private async Task LoadFiles()
    {
        try
        {
            // Only fetch if we have a valid URL
            if (!string.IsNullOrEmpty(listUrl))
            {
                 fileList = await Http.GetFromJsonAsync<List<BlobInfo>>(listUrl) ?? new List<BlobInfo>();
                 StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching files: {ex.Message}");
        }
    }

    public class BlobInfo
    {
        public string Name { get; set; }
        public long? Size { get; set; }
        public DateTimeOffset? LastModified { get; set; }

    }
}

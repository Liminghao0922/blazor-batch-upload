@page "/"
@using System.Net.Http.Headers
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@attribute [Authorize]
@inject HttpClient Http
@inject MessageService _message
@inject IAccessTokenProvider TokenProvider
@inject IConfiguration Configuration

<PageTitle>ファイル一括アップロード</PageTitle>

<AuthorizeView>
    <Authorized>
        <div style="padding: 24px; max-width: 800px; margin: 0 auto;">
            <Card Title="ファイル一括アップロード">
                <p>以下のエリアにファイルをドラッグ＆ドロップするか、クリックしてアップロードしてください。</p>

                <Upload Action="@uploadUrl"
                        Name="files"
                        Multiple="true"
                        Drag="true"
                        Headers="@headers"
                        OnChange="HandleChange">
                    <p class="ant-upload-drag-icon">
                        <Icon Type="inbox" />
                    </p>
                    <p class="ant-upload-text">クリック、またはファイルをこのエリアにドラッグしてアップロード</p>
                    <p class="ant-upload-hint">
                        単一または複数のファイルのアップロードをサポートしています。
                    </p>
                </Upload>
            </Card>
        </div>
    </Authorized>
    <NotAuthorized>
        <div style="text-align: center; margin-top: 50px;">
             <h2>ファイルをアップロードするにはログインしてください。</h2>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    Dictionary<string, string> headers = new Dictionary<string, string>();
    string uploadUrl = "";

    protected override async Task OnInitializedAsync()
    {
        var apiBaseUrl = Configuration["ApiBaseUrl"]; 
        if (string.IsNullOrEmpty(apiBaseUrl))
        {
             // Fallback if not configured (e.g. production SWA)
             // If ApiBaseUrl is explicit, use it. Otherwise assume relative path (SWA proxy)
             uploadUrl = "api/files/upload";
        }
        else 
        {
             uploadUrl = $"{apiBaseUrl}/api/files/upload";
        }

        var result = await TokenProvider.RequestAccessToken();
        if (result.TryGetToken(out var token))
        {
            headers["Authorization"] = $"Bearer {token.Value}";
        }
    }

    private void HandleChange(UploadInfo fileinfo)
    {
        if (fileinfo.File.State == UploadState.Success)
        {
            _message.Success($"{fileinfo.File.FileName} のアップロードに成功しました");
        }
        else if (fileinfo.File.State == UploadState.Fail)
        {
            _message.Error($"{fileinfo.File.FileName} のアップロードに失敗しました。サーバーエラー: {fileinfo.File.Response}");
        }
    }
}
